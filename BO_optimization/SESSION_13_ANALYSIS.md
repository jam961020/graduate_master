# Session 13 Analysis - Sobol Sequence Experiment

**Date**: 2025-11-14
**Status**: In Progress (36+ iterations completed)
**Experiment**: Sobol sequence environment sampling with Top 6 features

---

## 실험 설정

### 파라미터
- **Iterations**: 150 (목표)
- **n_initial**: 10
- **n_w**: 15 (Sobol sequence)
- **alpha**: 0.3
- **Environment**: Top 6 features (6D)
- **Parameters**: 8D
- **Total input**: 14D (8D params + 6D env)

### 이론적 근거
- Session 12에서 발견: 랜덤 환경 샘플링 → GP 학습 실패
- 해결책: Sobol sequence로 환경 공간 균등 커버
- 기대: KG 예측 정확도 향상, CVaR 개선

---

## 실험 결과 (36 iterations)

### 성능 지표

| 지표 | 값 | 비고 |
|------|-----|------|
| Initial CVaR | 0.4787 | - |
| Best CVaR | 0.5654 | Iter 9 달성 |
| Current CVaR | ~0.48 | Iter 36 |
| Overall improvement | +18.1% | Iter 9 기준 |
| Current from initial | -0.2% | 역전됨 |

### 구간별 성능

| Phase | Iterations | Mean CVaR | Best CVaR |
|-------|-----------|-----------|-----------|
| Phase 1 | 1-10 | 0.4990 | 0.5654 |
| Phase 2 | 11-20 | 0.5158 | 0.5635 |
| Phase 3 | 21-36 | ~0.51 | 0.5387 |

### 핵심 발견

**1. KG 예측 실패**
- KG vs Actual improvement correlation: **-0.253** (음수!)
- Session 12 (랜덤): -0.176
- Session 13 (Sobol): -0.253
- **결론**: Sobol이 KG 정확도를 개선시키지 못함, 오히려 악화

**2. CVaR과 Score 불일치**
- CVaR vs Score correlation: **-0.072** (거의 무관)
- Best CVaR (0.5654, Iter 9): 실제 Score 0.5127
- Best Score (0.8112, Iter 1): CVaR 0.4787
- **결론**: CVaR과 Score가 완전히 다른 파라미터를 가리킴

**3. 조기 수렴 후 정체**
- Iter 9에서 Best CVaR 달성
- 이후 27회 동안 개선 없음
- 0.47-0.56 범위에서 진동

---

## 근본 원인 분석

### GP 학습 데이터 구조

**실제 데이터 크기:**
```
초기화 (n_initial=10):
  - 10개 파라미터 X
  - 각 X를 15개 환경 W에서 평가
  - 초기 샘플: 10 × 15 = 150개

BO iterations (36회):
  - 매 iteration마다 1개 (x,w) 추가
  - 추가 샘플: 36개

총 GP 데이터: 150 + 36 = 186개 (14D)
```

**데이터 양은 충분**: 14D 학습에 186개면 rule of thumb (140개) 초과

### 진짜 문제: 데이터 분포의 불균형

**문제점:**
1. **초기 10개 X는 무작위 샘플** → 성능 낮음
2. **초기 150개 데이터**로 GP가 "X-W 관계" 학습
3. **BO가 새로운 (더 좋은) X 탐색**
4. **새 X에서 W 효과를 예측**해야 하는데...
5. **GP는 나쁜 X에서만 W 관계를 배움** → 외삽 실패!

**비유:**
- 초기 10대: "오래된 중고차들"을 다양한 타이어 압력에서 테스트
- BO 발견: "새 스포츠카"
- GP 예측: "중고차 데이터로 스포츠카 성능 예측하세요"
- 결과: 예측 실패!

### 악순환 구조

```
1. KG: "이 지점(x,w)이 CVaR 개선할 것 같아!" (높은 acq value)
   ↓ (잘못된 GP 예측 기반)

2. 실제 평가: CVaR 별로 안 올라감 또는 떨어짐
   ↓

3. GP: "이 새 데이터를 학습..." (외삽 실패로 잘못 학습)
   ↓

4. KG: "더 헷갈린다... 여기는?" (또 엉뚱한 곳)
   ↓

5. 반복 → CVaR이 0.47-0.56 사이 진동
```

---

## Sobol Sequence가 효과 없는 이유

### 이론 vs 실제

**이론적 기대:**
- Sobol로 환경 공간 균등 커버
- GP가 W 공간 전체 학습
- CVaR 추정 정확도 향상
- KG 예측 개선

**실제 문제:**
1. **초기 X가 나쁨**: Sobol이 W만 커버, X는 여전히 무작위
2. **X-W 교차 효과**: 나쁜 X에서 배운 W 효과가 좋은 X에 적용 안됨
3. **n_w=15 여전히 부족**: 6D 환경 공간에 15개는 sparse
4. **외삽 문제 근본 해결 못함**: 데이터 분포 불균형은 그대로

### 증거

| 지표 | Session 12 (Random) | Session 13 (Sobol) | 개선? |
|------|---------------------|---------------------|-------|
| Best CVaR | 0.5549 (Iter 42) | 0.5654 (Iter 9) | +1.9% |
| KG correlation | -0.176 | -0.253 | 악화 |
| CVaR-Score corr | 0.408 | -0.072 | 악화 |
| Convergence | 50회 | 9회 후 정체 | 빠름 but 낮음 |

**Sobol은 W 샘플링은 개선했으나 근본 문제(X-W 외삽)는 해결 못함**

---

## 비교 분석: 이전 성공 케이스

### Session (11/13) - CVaR 0.6886 달성

**왜 성공했나?**
- 환경 상관관계 **매우 약함** (r = 0.12)
- GP가 사실상 환경 무시하고 **파라미터만 최적화**
- 8D 파라미터 공간 → 외삽 문제 덜함
- 순수 parameter optimization처럼 작동

### Session 13 - CVaR 0.5654 (현재)

**왜 실패했나?**
- 환경 상관관계 **중간** (r = 0.33)
- GP가 환경 효과 학습 시도
- 14D 공간, X-W 교차 효과 외삽 실패
- BoRisk의 복잡도만 증가, 이점 없음

**역설:**
- 환경 상관이 약하면 → 환경 무시 → 성공!
- 환경 상관이 강하면 → 학습 시도 → 외삽 실패 → 실패!

---

## 해결 방안

### Option A: 환경 제거 (8D 파라미터만)

**장점:**
- 이전 성공 케이스와 동일 (CVaR 0.6886)
- GP 학습 간단, 외삽 문제 감소
- 빠름 (n_w 불필요)

**단점:**
- BoRisk 알고리즘 사용 안함
- 환경별 강건성 확보 못함

**추천도**: ⭐⭐⭐⭐⭐ (가장 안전)

### Option B: n_w 대폭 증가 (15 → 50+)

**장점:**
- 각 BO iteration X도 여러 W에서 평가
- X-W 관계를 새 X에서도 학습
- 외삽 문제 완화

**단점:**
- 매우 느림 (3배 이상)
- 여전히 초기 X 문제 존재

**추천도**: ⭐⭐⭐ (시간 여유 있으면)

### Option C: 초기 샘플링 개선

**방법:**
1. n_initial 증가 (10 → 30)
2. 더 나은 초기 X 선택 (Latin Hypercube, Grid)
3. 각 초기 X를 더 많은 W에서 평가

**장점:**
- GP가 좋은 X 영역에서 W 관계 학습
- 외삽 거리 감소

**단점:**
- 초기화 시간 증가
- 여전히 불확실

**추천도**: ⭐⭐⭐

### Option D: 획득함수 변경 (KG → UCB/EI)

**이유:**
- KG는 CVaR 정확도에 너무 의존
- UCB/EI는 단순, 외삽 문제에 덜 민감

**장점:**
- 구현 간단
- 안정적

**단점:**
- BoRisk의 핵심(CVaR-KG) 포기

**추천도**: ⭐⭐⭐⭐

---

## 결론 및 권장 사항

### 현재 실험 (Session 13)

**상태:**
- Sobol sequence는 이론적으로 옳지만 실제 효과 미미
- 근본 문제(X-W 외삽)는 미해결
- Iter 9 이후 개선 없음 (27회 정체)

**판단:**
- 50-75회까지 계속해도 개선 가능성 낮음
- **조기 종료 권장**

### 다음 실험 제안

**우선순위 1: 환경 없는 8D 파라미터 최적화**
```bash
python optimization.py \
    --iterations 50 \
    --n_initial 10 \
    --alpha 0.3 \
    --no_environment
```
- 이전 성공 케이스 재현
- 가장 안전한 선택

**우선순위 2: 환경 있지만 단순화**
- Top 3 features만 사용 (6D → 3D)
- n_w = 30으로 증가
- 획득함수 UCB로 변경

**우선순위 3: BoRisk 재설계**
- 초기 샘플 30개
- 각 초기 X를 30개 W에서 평가
- 초기 데이터: 30 × 30 = 900개
- 시간 많이 걸리지만 정석

---

## 교훈

### BoRisk 알고리즘의 한계

1. **데이터 효율성 vs 정확도 트레이드오프**
   - BoRisk는 적은 평가로 robust optimization
   - 하지만 GP가 정확해야 작동
   - 부정확한 GP → 오히려 역효과

2. **환경 특징의 양날의 검**
   - 상관 약하면 → 노이즈만 추가
   - 상관 강하면 → 외삽 실패
   - 중간이 가장 나쁨 (현재 상황)

3. **Quasi-Monte Carlo의 한계**
   - Sobol은 샘플링 커버리지 개선
   - 하지만 GP 외삽 문제는 못 풂
   - 데이터 분포 불균형이 더 큰 문제

### 성공 조건

BoRisk가 작동하려면:
1. 충분한 초기 샘플 (30+)
2. 초기 X가 다양하고 좋은 영역 포함
3. 각 X를 충분한 W에서 평가 (30+)
4. 환경 특징이 강하게 예측력 있음 (r > 0.5)

현재 실험은 이 조건들을 만족 못함.

---

**마지막 업데이트**: 2025-11-14 (36 iterations 분석)
**다음 액션**: 환경 없는 8D 실험으로 전환 추천
