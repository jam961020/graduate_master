# 역설: 환경 연관성이 높을수록 성능이 나쁜 이유

**Date**: 2025-11-14
**Issue**: 환경 특징 상관관계가 강할수록 BO 성능이 오히려 나빠짐
**Status**: 🚨 CRITICAL PARADOX - Opus 논의 필요

---

## 📊 실험 결과 비교

### Session (11/13) - 6D Basic Environment

| 항목 | 값 |
|------|-----|
| Environment features | 6D basic (brightness, contrast, edge_density, etc.) |
| Environment 상관관계 | **r = 0.12** (WEAK, 거의 무관) |
| Best CVaR | **0.6886** ✅ |
| KG correlation | Low but somewhat working |
| 결과 | **SUCCESS** |

### Session 13 (11/14) - Top 6 Environment

| 항목 | 값 |
|------|-----|
| Environment features | Top 6 (local_contrast, clip_rough, brightness, etc.) |
| Environment 상관관계 | **r = 0.33** (MODERATE, 중간 강도) |
| Best CVaR | **0.5654** ❌ |
| KG correlation | -0.253 (NEGATIVE!) |
| 결과 | **FAILURE** |

### 비교 요약

```
환경 상관 WEAK (r=0.12)  →  CVaR 0.6886  ✅ (좋음!)
환경 상관 MODERATE (r=0.33)  →  CVaR 0.5654  ❌ (나쁨!)

차이: -19% 성능 하락
```

---

## 🤔 왜 이런 역설이 발생하는가?

### 직관적 기대 (WRONG!)

```
환경 상관 높음 → 환경이 성능에 영향 큼
              → GP가 환경 효과 학습
              → 더 정확한 예측
              → 더 좋은 최적화
              → CVaR 향상 ✅
```

**하지만 현실은 정반대!**

### 실제 현상 (ACTUAL)

```
환경 상관 높음 → GP가 환경 효과 학습 시도
              → 초기 X(나쁨)에서만 W 관계 학습
              → 새 X(좋음)에서 W 효과를 잘못 외삽
              → CVaR 예측 실패
              → KG가 잘못된 지점 선택
              → CVaR 하락 ❌
```

---

## 🔬 세부 분석

### Case 1: 환경 상관 WEAK (r=0.12) - 성공

**상황:**
- 환경이 성능에 거의 영향 없음 (노이즈 수준)
- GP가 환경 차원을 사실상 무시
- **순수 파라미터 최적화처럼 작동**

**GP 학습:**
```python
f(x, w) ≈ f(x)  # w는 무시됨
```

**외삽 문제:**
- 없음! w가 영향 없으니 외삽할 필요 없음
- 새 X에서도 단순히 X만 예측

**결과:**
- GP가 안정적으로 X → Y 매핑 학습
- BO가 정상 작동
- CVaR 0.6886 달성 ✅

---

### Case 2: 환경 상관 MODERATE (r=0.33) - 실패

**상황:**
- 환경이 성능에 **실제로 영향 있음**
- GP가 환경 효과 학습 시도
- **X-W 교차 효과 외삽 필요**

**GP 학습:**
```python
f(x, w) = g(x) + h(w) + interaction(x, w)
          ↑      ↑      ↑
       파라미터  환경  교차효과 (문제!)
```

**초기 데이터 (150개):**
- 10개의 나쁜 X (무작위 초기화)
- 각 X를 15개 W에서 평가
- GP 학습: "나쁜 X에서 W가 어떻게 영향을 주는가"

**BO 탐색 (35개):**
- 35개의 새로운 X (더 좋은 영역)
- 각 X를 1개 W에서만 평가
- GP 예측: "새 X에서 다른 14개 W의 성능은?"

**외삽 문제 발생:**

```
나쁜 X 영역:
  X1: W1→0.3, W2→0.4, W3→0.5  (학습됨)
  X2: W1→0.2, W2→0.3, W3→0.4  (학습됨)
  ...
  → GP: "이 X 영역에서 W의 영향 = +0.1씩"

좋은 X 영역 (BO가 발견):
  X_new: W1→0.7 (평가함)
  X_new: W2→?, W3→?, ... (예측 필요!)

  GP 예측: "나쁜 X처럼 W의 영향 = +0.1씩일 것"
           W2 = 0.8, W3 = 0.9 예측

  실제:     W2 = 0.5, W3 = 0.4 (완전 다름!)
           → 좋은 X는 특정 W에서만 잘 작동
```

**결과:**
- CVaR 계산 틀림 (잘못된 W 예측 사용)
- KG가 잘못된 다음 X 선택
- 악순환 → CVaR 0.5654 ❌

---

## 💡 핵심 통찰

### 1. "교차 효과(Interaction)"의 저주

**환경 상관 약하면:**
```
f(x, w) ≈ g(x) + noise(w)
→ 교차 효과 없음
→ 외삽 필요 없음
→ 안전!
```

**환경 상관 강하면:**
```
f(x, w) = complex_interaction(x, w)
→ X마다 W의 영향이 다름
→ 새 X에서 W 효과 예측해야 함
→ 외삽 실패!
```

### 2. 데이터 분포의 중요성

**문제의 핵심:**
- 초기 10개 X: **파라미터 공간의 구석** (무작위, 성능 나쁨)
- BO 탐색 X: **파라미터 공간의 중심** (최적화된, 성능 좋음)
- GP: "구석에서 배운 X-W 관계"를 "중심에 적용"
- **외삽 거리가 너무 멈!**

**비유:**
```
초기 10개 X: "산 정상에서 날씨 효과" 학습
  - 추움, 바람 강함, 산소 부족

BO가 찾은 X: "산 중턱"
  - GP: "중턱도 추울 것" (틀림!)
  - 실제: 따뜻함

→ 예측 실패!
```

### 3. 차원의 저주 (Curse of Dimensionality)

**환경 상관 약하면:**
- 실질적 차원: 8D (파라미터만)
- GP가 배우기 쉬움

**환경 상관 강하면:**
- 실질적 차원: 14D (파라미터 8D + 환경 6D)
- **교차 항까지 고려하면: 8×6 = 48D!**
- GP가 배우기 매우 어려움

---

## 🎯 이론적 설명

### BoRisk 논문의 가정

**BoRisk가 작동하려면:**
1. **환경 공간이 잘 커버됨** (Sobol ✓)
2. **파라미터 공간도 잘 커버됨** (❌ 초기 10개만)
3. **X-W 교차 효과가 부드러움** (❌ 급격히 변함)
4. **충분한 초기 샘플** (❌ 10개는 너무 적음)

현재 실험은 1번만 만족, 나머지 실패!

### GP 외삽 이론

**GP의 예측 불확실성:**
```
Var[f(x_new)] = k(x_new, x_new) - k(x_new, X)^T K^(-1) k(x_new, X)
                                   ↑
                              학습 데이터 X와 멀수록 증가
```

**새 X가 초기 X와 멀면:**
- 예측 분산 ↑ (불확실성 ↑)
- 평균 예측도 부정확
- CVaR 계산 틀림

---

## 📐 수학적 분석

### 환경 효과의 지역성 (Locality)

**가정:**
```
f(x, w) = g(x) + h(w, x)
```

여기서 `h(w, x)`는 X에 따라 다른 환경 효과

**초기 X 영역에서:**
```
h(w, x_init) ≈ α_init · w
```

**새 X 영역에서:**
```
h(w, x_new) ≈ α_new · w  (α_new ≠ α_init)
```

**GP의 예측:**
```
GP는 α_init로 학습했으므로
h(w, x_new) ≈ α_init · w로 예측 (틀림!)
```

**CVaR 계산:**
```
CVaR_true = E[f(x_new, w) | f(x_new, w) ≤ quantile]
CVaR_pred = E[f_GP(x_new, w) | f_GP(x_new, w) ≤ quantile]

f_GP ≠ f_true → CVaR_pred ≠ CVaR_true
→ KG 최적화가 잘못된 목표를 향함!
```

---

## 🔍 증거

### 실험 데이터 분석

**Session 13 데이터:**

```
Best CVaR (0.5654, Iter 9):
  - 실제 Score: 0.5127

Best Score (0.8112, Iter 1):
  - CVaR: 0.4787

→ CVaR과 Score가 다른 파라미터!
→ GP 예측 완전히 틀림
```

**KG 예측 vs 실제:**

```
KG 높음 (1.4+) → 예상: CVaR 개선
실제: CVaR 하락 또는 정체

상관관계: -0.253 (반대 방향!)
```

---

## 🎓 결론

### 왜 환경 상관이 높을수록 성능이 나쁜가?

**핵심 이유:**

1. **환경 상관 약함 (r=0.12):**
   - GP: "환경은 노이즈다, 무시하자"
   - 실질적으로 8D 파라미터 최적화
   - 외삽 문제 없음
   - **단순하고 안전** ✅

2. **환경 상관 중간 (r=0.33):**
   - GP: "환경이 영향 있다, 학습하자"
   - 하지만 초기 X에서만 W 관계 학습
   - 새 X에서 W 효과를 잘못 외삽
   - **복잡하고 위험** ❌

3. **환경 상관 매우 강함 (r>0.7, 이론적):**
   - 충분한 데이터 있으면 정확히 학습 가능
   - 하지만 필요 데이터 = 수백~수천 개
   - 현실적으로 불가능

### 일반화된 원리

```
환경 상관 강도 vs BO 성능:

약함 (0~0.2):   성능 좋음 (환경 무시 가능)
              ✅ 단순, 안정

중간 (0.2~0.5): 성능 나쁨 (환경 고려해야 하지만 학습 실패)
              ❌ 복잡, 불안정
              ⚠️ 현재 상황!

강함 (0.5~0.7): 성능 좋을 수 있음 (충분한 데이터 시)
              ⚡ 데이터 많이 필요

매우 강함 (0.7+): 성능 좋음 (환경이 지배적, 학습 쉬움)
                  ✅ 하지만 데이터 매우 많이 필요
```

**현재는 최악의 중간 지대!**

---

## 💬 Opus와 논의할 질문

### 1. 이론적 타당성

**질문:**
- 이 "역설"이 BoRisk 논문에서 언급되었나?
- GP 외삽 실패가 근본 원인이 맞나?
- 환경 상관 중간일 때가 최악인 이유?

### 2. 해결 방안

**질문:**
- 초기 샘플링을 어떻게 개선해야 하나?
- n_w를 얼마나 늘려야 효과가 있나?
- 다른 획득함수(UCB, EI)가 이 문제를 피할 수 있나?
- GP 커널을 변경하면 도움이 될까? (e.g., Matern)

### 3. 실험 설계

**질문:**
- 환경 제거 vs 환경 유지 중 어느 쪽이 나은가?
- Top 6 features가 진짜 좋은 선택인가?
- 상관관계 0.33이 "유용한" 수준인가?
- 다른 환경 특징 조합을 시도해야 하나?

### 4. 논문 작성

**질문:**
- 이 역설을 어떻게 설명할 것인가?
- Limitation으로 인정해야 하나?
- 개선 방안을 제시할 수 있나?

---

## 📊 제안하는 추가 실험

### Experiment A: 환경 상관도별 비교

```
환경 특징:
1. Weak (r=0.1):   Random noise
2. Moderate (r=0.3): Top 6 (현재)
3. Strong (r=0.6):  ??? (찾기)

각각 동일 조건으로 50 iterations
→ 환경 상관 vs 성능 곡선 확인
```

### Experiment B: 초기 샘플 수 증가

```
n_initial:
1. 10 (현재, 실패)
2. 30
3. 50
4. 100

각각 Top 6 환경, 50 iterations
→ 초기 샘플이 외삽 문제 해결하는지 확인
```

### Experiment C: n_w 증가

```
n_w:
1. 15 (현재, 실패)
2. 30
3. 50
4. 100

각각 Top 6 환경, 30 iterations
→ 더 많은 W 샘플이 도움 되는지 확인
```

---

## 🎯 즉시 액션

**1. Opus에게 질문 준비**
- 이 문서를 Opus에게 보여주기
- 이론적 타당성 확인
- 해결 방안 논의

**2. 현재 실험 결정**
- Session 13: 50회에서 조기 종료
- 새 실험: 환경 없는 8D 시작

**3. 문서 업데이트**
- SESSION_13_ANALYSIS.md에 이 내용 링크
- NEXT_SESSION.md 업데이트

---

**마지막 업데이트**: 2025-11-14
**상태**: 🚨 CRITICAL PARADOX
**다음 단계**: Opus 논의 필요
